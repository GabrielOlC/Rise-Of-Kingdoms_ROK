# File objective

> The objective of this app is to provide summaries and insights from kingdom scans. It merges multiple files generated by the scans and ensures that the raw data is free from errors or inconsistencies (scans often contain many issues).
> 
> The app calculates scores for T1, T2, T3, T4, T5, deaths, kill points (KP), and resource assistance, both during the war and across the entire KvK event. It removes points from lists such as zeroing or feeding and computes CP (points used for purchasing ranks or other resources that the kingdom council may like). Additionally, it calculates individual player contributions to facilitate fair and efficient creation of yellow, red and black lists, as well as determining rewards based on effort. The app includes a setup page where users can define desired goals, metrics, and functions to customize its operations for every kvk—this settings may be updated at any time.
> Finally, all the results are posted online with PowerBI so everyone can see your progress through kvks

### Observations

* [x] Some Query snippets have been left out. Check the files directly.

* [x] Some Excel functions have been left out. Check the files directly.

* [x] Some VBA worksheet triggers have been left out. Check the files directly

* [x] Some VBA Sub or Functions have been left out. Check the file directly

## Update notes (check monday to see full backlog)

| Item                                                                                     | What to update?        | What's the subject? | Status            |
| ---------------------------------------------------------------------------------------- |:----------------------:|:-------------------:|:-----------------:|
| Added for every MI: Remove error for the name and ID                                     | Documentation          | Power query         | Approved to start |
| I have added a function to move CP from farms and alts to main. Needs an equation update | Documentation          | Excel               | Approved to start |
| Update calculation on player standards                                                   | Equations/Calculations | Excel               | Suggestion        |
| Do not allow HOH calculations to give negative values                                    | Equations/Calculations | Excel               | Approved to start |
| Update the column "kill goals achieved"                                                  | Documentation          | Excel               | Approved to start |
| Update the way HOH values are considered                                                 | Equations/Calculations | Excel               | Suggestion        |
| Update the "Check Data Structure" error analysis                                         | Equations/Calculations | Excel               | Approved to start |
| Add an error type to "Check Data Structure" for people who are not in all scans          | Equations/Calculations | Excel               | Approved to start |
| Update the bases calculations for "Achievements Contribution"                            | Equations/Calculations | Excel               | Approved to start |
| Bring the Excel charts to BI... it’s about time to do so                                 | Coding                 | BI                  | Approved to start |
| Add the schedule to BI as well (from the file "ToW timeline.xlsx")                       | Coding                 | BI                  | Approved to start |
| Change data sources from XLS to CSV                                                      | Coding                 | Power query         | Suggestion        |
| Change final interface (with results) into a Python dashboard                            | Coding                 | Python + WEB        | Suggestion        |
| Update GL deaths in MI                                                                   | Equations/Calculations | Excel               | Approved to start |

---

![](https://github.com/GabrielOlC/GeFu_BackUP/blob/main/.Images/Picture10.jpg?raw=true)

![](https://github.com/GabrielOlC/GeFu_BackUP/blob/main/.Images/Picture11.jpg?raw=true)

![](https://github.com/GabrielOlC/GeFu_BackUP/blob/main/.Images/Picture12.jpg?raw=true)

---

# About Source files and queries for Report

The data is downloaded to the excel through M and in order to the code work, the source files need:

- To be saved as 'xls' or 'xlsx'.

- To follow this name structure: Fx.y -- any name or observation.
  
  - X -- the number of the fight, there will always have 2 files with
    the same number.
  
  - Y -- the letter 'A' for after and 'B' for before.
  
  - Example for a first fight: F1.B -- some name; F1.A -- some name; the
    code will do A -- B on the calculations.

- Follow this column structure (including the caps, do not change a
  thing):
  
  - Governor name as string.
  
  - Governor ID as integer.
  
  - Power as integer.
  
  - Alliance as string.
  
  - Kill points as integer.
  
  - Deads as integer.
  
  - Tier 4 Kills as integer.
  
  - Tier 5 Kills as integer.
  
  - Rss assistance as integer.
  
  - Alliance help as integer.
  
  - Notes as string.

## Source treated

>  This query organizes the data coming from the source files.

```powerquery
Let
    Source = Folder.Files(p_PathToScanData),
    #"Filtered Hidden Files1" = Table.SelectRows(Source, Each [Attributes]?[Hidden]? <> True),
    #"Invoke Custom Function1" = Table.AddColumn(#"Filtered Hidden Files1", "Transform File", Each #"Transform File"([Content])),
    #"Renamed Columns1" = Table.RenameColumns(#"Invoke Custom Function1", {"Name", "Source.Name"}),
    #"Removed Other Columns1" = Table.SelectColumns(#"Renamed Columns1", {"Source.Name", "Transform File"}),
    #"Expanded Table Column1" = Table.ExpandTableColumn(#"Removed Other Columns1", "Transform File", Table.ColumnNames(#"Transform File"(#"Sample File"))),
    #"Changed Type" = Table.TransformColumnTypes(#"Expanded Table Column1",{{"Source.Name", type text}, {"Governor Name", type text}, {"Governor ID", Int64.Type}, {"Power", Int64.Type}, {"Alliance", type text}, {"Kill Points", Int64.Type}, {"Deads", Int64.Type}, {"Tier 4 Kills", Int64.Type}, {"Tier 5 Kills", Int64.Type}, {"Rss Assistance", Int64.Type}, {"Alliance Help", Int64.Type}, {"Notes", type text}}),
    #"Filtered Rows" = Table.SelectRows(#"Changed Type", Each ([Governor ID] <> Null)),
    #"Split Column by Delimiter" = Table.SplitColumn(#"Filtered Rows", "Source.Name", Splitter.SplitTextByEachDelimiter({" - "}, QuoteStyle.Csv, False), {"Source.Name.1", "Source.Name.2"}),
    #"Changed Type1" = Table.TransformColumnTypes(#"Split Column by Delimiter",{{"Source.Name.1", type text}, {"Source.Name.2", type text}}),
    #"Split Column by Delimiter1" = Table.SplitColumn(#"Changed Type1", "Source.Name.1", Splitter.SplitTextByEachDelimiter({"."}, QuoteStyle.Csv, False), {"Source.Name.1.1", "Source.Name.1.2"}),
    #"Changed Type2" = Table.TransformColumnTypes(#"Split Column by Delimiter1",{{"Source.Name.1.1", type text}, {"Source.Name.1.2", type text}}),
    #"Removed Columns" = Table.RemoveColumns(#"Changed Type2",{"Source.Name.2"})
in
    #"Removed Columns"

```

## Source structure

> This query advances the 'Source treated' getting the first totals of kills, dead, kill points, etc.

Thise use:

- Source treated.

```powerquery
Let
    Source = #"Source Treated",

    #"Whole Table" = Table.RenameColumns(Source,{{"Source.Name.1.2", "After(A) - Before(B)"}, {"Source.Name.1.1", "File Block"}}),

    //Manual adding source blocks
    //B Is Before And A Is After


     #"F1 A" = Table.SelectRows(#"Whole Table", Each ([File Block] = "F1") And ([#"After(A) - Before(B)"] = "A")),
     #"F1 B" = Table.SelectRows(#"Whole Table", Each ([File Block] = "F1") And ([#"After(A) - Before(B)"] = "B")),

     #"F2 A" = Table.SelectRows(#"Whole Table", Each ([File Block] = "F2") And ([#"After(A) - Before(B)"] = "A")),
     #"F2 B" = Table.SelectRows(#"Whole Table", Each ([File Block] = "F2") And ([#"After(A) - Before(B)"] = "B")),

     #"F3 A" = Table.SelectRows(#"Whole Table", Each ([File Block] = "F3") And ([#"After(A) - Before(B)"] = "A")),
     #"F3 B" = Table.SelectRows(#"Whole Table", Each ([File Block] = "F3") And ([#"After(A) - Before(B)"] = "B")),

     #"F4 A" = Table.SelectRows(#"Whole Table", Each ([File Block] = "F4") And ([#"After(A) - Before(B)"] = "A")),
     #"F4 B" = Table.SelectRows(#"Whole Table", Each ([File Block] = "F4") And ([#"After(A) - Before(B)"] = "B")),

     #"F5 A" = Table.SelectRows(#"Whole Table", Each ([File Block] = "F5") And ([#"After(A) - Before(B)"] = "A")),
     #"F5 B" = Table.SelectRows(#"Whole Table", Each ([File Block] = "F5") And ([#"After(A) - Before(B)"] = "B")),

     #"F6 A" = Table.SelectRows(#"Whole Table", Each ([File Block] = "F6") And ([#"After(A) - Before(B)"] = "A")),
     #"F6 B" = Table.SelectRows(#"Whole Table", Each ([File Block] = "F6") And ([#"After(A) - Before(B)"] = "B")),

    //Extra To Calculate the totals in And out war And be easy To update
     #"First" = #"F1 B",
     #"Last" = #"F6 A",
      #"Replaced Last" = Table.ReplaceValue(#"Last","F6","Last",Replacer.ReplaceText,{"File Block"}), //Replacing the initial name To sort later And use without create more tables

    //Merginging blocks AB And expanding

     #"MG_F1 AB" = Table.NestedJoin(#"F1 A", {"Governor ID"}, #"F1 B", {"Governor ID"}, "F1 B", JoinKind.LeftOuter),
     #"EP_F1 AB" = Table.ExpandTableColumn(#"MG_F1 AB", "F1 B", {"Kill Points", "Deads", "Tier 4 Kills", "Tier 5 Kills", "Rss Assistance", "Alliance Help", "Notes"}, {"B.Kill Points", "B.Deads", "B.Tier 4 Kills", "B.Tier 5 Kills", "B.Rss Assistance", "B.Alliance Help", "B.Notes"}),

     #"MG_F2 AB" = Table.NestedJoin(#"F2 A", {"Governor ID"}, #"F2 B", {"Governor ID"}, "F2 B", JoinKind.LeftOuter),
     #"EP_F2 AB" = Table.ExpandTableColumn(#"MG_F2 AB", "F2 B", {"Kill Points", "Deads", "Tier 4 Kills", "Tier 5 Kills", "Rss Assistance", "Alliance Help", "Notes"}, {"B.Kill Points", "B.Deads", "B.Tier 4 Kills", "B.Tier 5 Kills", "B.Rss Assistan#"MG_F3 AB" = Table.NestedJoin(#"F3 A", {"Governor ID"}, #"F3 B", {"Governor ID"}, "F3 B", JoinKind.LeftOuter),
     #"EP_F3 AB" = Table.ExpandTableColumn(#"MG_F3 AB", "F3 B", {"Kill Points", "Deads", "Tier 4 Kills", "Tier 5 Kills", "Rss Assistance", "Alliance Help", "Notes"}, {"B.Kill Points", "B.Deads", "B.Tier 4 Kills", "B.Tier 5 Kills", "B.Rss Assistance", "B.Alliance Help", "B.Notes"}),

     #"MG_F4 AB" = Table.NestedJoin(#"F4 A", {"Governor ID"}, #"F4 B", {"Governor ID"}, "F4 B", JoinKind.LeftOuter),
     #"EP_F4 AB" = Table.ExpandTableColumn(#"MG_F4 AB", "F4 B", {"Kill Points", "Deads", "Tier 4 Kills", "Tier 5 Kills", "Rss Assistance", "Alliance Help", "Notes"}, {"B.Kill Points", "B.Deads", "B.Tier 4 Kills", "B.Tier 5 Kills", "B.Rss Assistance", "B.Alliance Help", "B.Notes"}),

     #"MG_F5 AB" = Table.NestedJoin(#"F5 A", {"Governor ID"}, #"F5 B", {"Governor ID"}, "F5 B", JoinKind.LeftOuter),
     #"EP_F5 AB" = Table.ExpandTableColumn(#"MG_F5 AB", "F5 B", {"Kill Points", "Deads", "Tier 4 Kills", "Tier 5 Kills", "Rss Assistance", "Alliance Help", "Notes"}, {"B.Kill Points", "B.Deads", "B.Tier 4 Kills", "B.Tier 5 Kills", "B.Rss Assistance", "B.Alliance Help", "B.Notes"}),

     #"MG_F6 AB" = Table.NestedJoin(#"F6 A", {"Governor ID"}, #"F6 B", {"Governor ID"}, "F6 B", JoinKind.LeftOuter),
     #"EP_F6 AB" = Table.ExpandTableColumn(#"MG_F6 AB", "F6 B", {"Kill Points", "Deads", "Tier 4 Kills", "Tier 5 Kills", "Rss Assistance", "Alliance Help", "Notes"}, {"B.Kill Points", "B.Deads", "B.Tier 4 Kills", "B.Tier 5 Kills", "B.Rss Assistance", "B.Alliance Help", "B.Notes"}),

    // Doing For the first And last 
         #"MG_FirstLast" = Table.NestedJoin(#"Replaced Last", {"Governor ID"}, #"First", {"Governor ID"}, "First", JoinKind.LeftOuter),
         #"EP_FirstLast" = Table.ExpandTableColumn(#"MG_FirstLast", "First", {"Kill Points", "Deads", "Tier 4 Kills", "Tier 5 Kills", "Rss Assistance", "Alliance Help", "Notes"}, {"B.Kill Points", "B.Deads", "B.Tier 4 Kills", "B.Tier 5 Kills", "B.Rss Assistance", "B.Alliance Help", "B.Notes"}),

// keeping B To be able To merge :)

    //Appeding Mergins
     #"Appended Query" = Table.Combine({#"EP_F1 AB", #"EP_F2 AB", #"EP_F3 AB", #"EP_F4 AB",#"EP_F5 AB", #"EP_F6 AB", #"EP_FirstLast"}),
    //Adding totals With logic
     #"TL - Kill Points" = Table.AddColumn(#"Appended Query", "Totals Kill Points", Each If [Kill Points] = Null Or [B.Kill Points] = Null Then 0 Else If [Kill Points] >= [B.Kill Points] Then [Kill Points] - [B.Kill Points] Else "Not Supposed to be negative"),
     #"TL - Deads" = Table.AddColumn(#"TL - Kill Points", "Totals Deads", Each If [Deads] = Null Or [B.Deads] = Null Then 0 Else If [Deads] >= [B.Deads] Then [Deads] - [B.Deads] Else "Not Supposed to be negative"),
     #"TL - Tier 4 Kills" = Table.AddColumn(#"TL - Deads", "Totals Tier 4 Kills", Each If [Tier 4 Kills] = Null Or  [B.Tier 4 Kills] = Null Then 0 Else If [Tier 4 Kills] >= [B.Tier 4 Kills] Then [Tier 4 Kills] - [B.Tier 4 Kills] Else "Not Supposed to be negative"),
     #"TL - Tier 5 Kills" = Table.AddColumn(#"TL - Tier 4 Kills", "Totals Tier 5 Kills", Each If [Tier 5 Kills] = Null Or [B.Tier 5 Kills] = Null Then 0 Else If [Tier 5 Kills] >= [B.Tier 5 Kills] Then [Tier 5 Kills] - [B.Tier 5 Kills] Else "Not Supposed to be negative"),
     #"TL - Rss Assistance" = Table.AddColumn(#"TL - Tier 5 Kills", "Totals Rss Assistance", Each If [Rss Assistance] = Null Or [B.Rss Assistance] = Null Then 0 Else If [Rss Assistance] >= [B.Rss Assistance] Then [Rss Assistance] - [B.Rss Assistance] Else "Not Supposed to be negative"),
    #"Renamed Columns" = Table.RenameColumns(#"TL - Rss Assistance",{{"Totals Deads", "Totals Dead"}, {"B.Deads", "B.Dead"}, {"Deads", "Dead"}})
in
    #"Renamed Columns"
ce", "B.Alliance Help", "B.Notes"}),

```

## Check data structure

> This query advances 'source structure' and merges with qr_tbDash to get the status, the main objective of this query is giving a view of how every step of the calculations are for each ID.

This use:

- Source structure

- qr_tbDash

```powerquery
Let
    Source = #"Source structure",
    #"Renamed Columns" = Table.RenameColumns(Source,{{"Dead", "Deads"}, {"B.Dead", "B.Deads"}, {"Totals Dead", "Totals Deads"}}),
    #"Merged Queries" = Table.NestedJoin(#"Renamed Columns", {"Governor ID"}, qr_tbDash, {"ID"}, "tbDash", JoinKind.LeftOuter),
    #"Expanded tbDash" = Table.ExpandTableColumn(#"Merged Queries", "tbDash", {"Player Goals", "Merged Status"}, {"Player Goals", "Status"}),
    #"Reordered Columns" = Table.ReorderColumns(#"Expanded tbDash",{"Status", "Player Goals", "File Block", "After(A) - Before(B)", "Governor Name", "Governor ID", "Power", "Alliance", "Kill Points", "Deads", "Tier 4 Kills", "Tier 5 Kills", "Rss Assistance", "Alliance Help", "Notes", "B.Kill Points", "B.Deads", "B.Tier 4 Kills", "B.Tier 5 Kills", "B.Rss Assistance", "B.Alliance Help", "B.Notes", "Totals Kill Points", "Totals Deads", "Totals Tier 4 Kills", "Totals Tier 5 Kills", "Totals Rss Assistance"}),
    #"Renamed Columns1" = Table.RenameColumns(#"Reordered Columns",{{"Totals Deads", "Totals Dead"}, {"B.Deads", "B.Dead"}, {"Deads", "Dead"}})

in
    #"Renamed Columns1"

```

## Data

> This query advances the 'Check data structure' getting the total of totals and the global totals.

This use:

- Check data structure.

```powerquery
Let
    Source = #"Source structure",
    #"Renamed Columns1" = Table.RenameColumns(Source,{{"Dead", "Deads"}, {"B.Dead", "B.Deads"}, {"Totals Dead", "Totals Deads"}}),
    #"Filtered Rows1" = Table.SelectRows(#"Renamed Columns1", Each ([File Block] <> "Last")),
    #"Global Values" = Table.SelectRows(#"Renamed Columns1", Each ([File Block] = "Last")), // used at the End
    // Removing errors - any error will Not be summed in the totals of totals, they must be fixed. Use the other query I made To check ids With Error
     #"Changed Type3" = Table.TransformColumnTypes(#"Filtered Rows1",{{"Totals Rss Assistance", Int64.Type}, {"Totals Tier 5 Kills", Int64.Type}, {"Totals Tier 4 Kills", Int64.Type}, {"Totals Deads", Int64.Type}, {"Totals Kill Points", Int64.Type}}),
     #"Removed Errors" = Table.RemoveRowsWithErrors(#"Changed Type3", {"Totals Kill Points", "Totals Deads", "Totals Tier 4 Kills", "Totals Tier 5 Kills", "Totals Rss Assistance"}),
    //Total of totals
     #"Grouped Rows" = Table.Group(#"Removed Errors", {"Governor ID"}, {{"Total of Totals Kill Points", Each List.Sum([Totals Kill Points]), type nullable number}, {"Total of totals Deads", Each List.Sum([Totals Deads]), type nullable number}, {"Total of totals Tier 4 Kills", Each List.Sum([Totals Tier 4 Kills]), type nullable number}, {"Total of totals Tier 5 Kills", Each List.Sum([Totals Tier 5 Kills]), type nullable number}, {"Total of totals Rss Assistance", Each List.Sum([Totals Rss Assistance]), type nullable number}, {"Average Help", Each List.Average([Alliance Help]), type nullable number}}),
    // Adding the global totals (info in And out war)
     #"All Data" = Table.NestedJoin(#"Grouped Rows", {"Governor ID"}, #"Global Values", {"Governor ID"}, "Global", JoinKind.LeftOuter),
    #"Expanded Global" = Table.ExpandTableColumn(#"All Data", "Global", {"Totals Kill Points", "Totals Deads", "Totals Tier 4 Kills", "Totals Tier 5 Kills", "Totals Rss Assistance"}, {"Global Kill Points", "Global Deads", "Global Tier 4 Kills", "Global Tier 5 Kills", "Global Rss Assistance"}),
    #"Changed Type" = Table.TransformColumnTypes(#"Expanded Global",{{"Global Kill Points", Int64.Type}, {"Global Deads", Int64.Type}, {"Global Tier 4 Kills", Int64.Type}, {"Global Tier 5 Kills", Int64.Type}, {"Global Rss Assistance", Int64.Type}}),
    #"Removed Errors1" = Table.RemoveRowsWithErrors(#"Changed Type", {"Global Kill Points", "Global Deads", "Global Tier 4 Kills", "Global Tier 5 Kills", "Global Rss Assistance"}),
    #"Merged Queries" = Table.NestedJoin(#"Removed Errors1", {"Governor ID"}, qr_tbDash, {"ID"}, "tbDash", JoinKind.LeftOuter),
    #"Expanded tbDash" = Table.ExpandTableColumn(#"Merged Queries", "tbDash", {"Name", "Player Goals", "Merged Status"}, {"Name", "Player Goals", "Status"}),
    #"Reordered Columns" = Table.ReorderColumns(#"Expanded tbDash",{"Status", "Player Goals", "Name", "Governor ID", "Total of Totals Kill Points", "Total of totals Deads", "Total of totals Tier 4 Kills", "Total of totals Tier 5 Kills", "Total of totals Rss Assistance", "Average Help", "Global Kill Points", "Global Deads", "Global Tier 4 Kills", "Global Tier 5 Kills", "Global Rss Assistance"}),
    #"Renamed Columns" = Table.RenameColumns(#"Reordered Columns",{{"Total of totals Deads", "Total of totals Dead"}, {"Global Deads", "Global Dead"}})
in
    #"Renamed Columns"

```

## Supportive queries

> These queries support in some manner the others

### Summed data as query (qr_tbDash)

> This gets the 'summed data' table and load to the query.

```powerquery
Let
    Source = Excel.CurrentWorkbook(){[Name="tbDash"]}[Content],
    #"Inserted Merged Column" = Table.AddColumn(Source, "Merged Status", Each Text.Combine({[System Status], [Player Status]}, " - "), type text),
    #"Changed Type" = Table.TransformColumnTypes(#"Inserted Merged Column",{{"Top   Power", Int64.Type}, {"Main acc ID", Int64.Type}, {"System Status", type text}, {"Player Status", type any}, {"Name", type text}, {"ID", Int64.Type}, {"Pre_Player Power", Int64.Type}, {"Alliance", type any}, {"Imported TL_Kill Points", Int64.Type}, {"Imported TL_dead", Int64.Type}, {"Imported TL_T4 Kills", Int64.Type}, {"Imported TL_T5Kills", Int64.Type}, {"Imported TL_Rss Assis", Int64.Type}, {"GL Imported TL_Kill Points", Int64.Type}, {"GL Imported TL_dead", Int64.Type}, {"GL Imported TL_T4 Kills", Int64.Type}, {"GL Imported TL_T5Kills", Int64.Type}, {"GL Imported TL_Rss Assis", Int64.Type}, {"HOH T4 dead", Int64.Type}, {"HOH T5 dead", Int64.Type}, {"PRE KVK stats", Int64.Type}, {"Old kvk CP", Int64.Type}, {"Payment CP", Int64.Type}, {"Manual CP", Int64.Type}, {"Avaible CP Points", type number}, {"Kill goals achieved", Percentage.Type}, {"SP_Dead goals achieved", Percentage.Type}, {"GL_Dead Goals achieved", Percentage.Type}, {"Achievements Contribution", type any}, {"Goals Contribution", Percentage.Type}, {"Player Standards", Percentage.Type}, {"Player Goals", type text}, {"VF_Data Proof Dead", type text}, {"Contribution rank", Int64.Type}, {"Achievements Contributions Rank", Int64.Type}, {"CP Rank", Int64.Type}, {"Kills rank", Int64.Type}, {"Dead in war rank", Int64.Type}, {"Sorting_Type1", type logical}, {"Sorting_Type2", type logical}, {"Sup_HOH T4 + HOH T5 Kills", Int64.Type}, {"Sub_Align dead CP", Int64.Type}, {"Sup_Zeroed T4 dead", type number}, {"Sup_Zeroed T5 dead", type number}, {"Sup_Goals Achieved", type number}, {"Sup_UseStatus", type logical}, {"Merged Status", type text}})
in
    #"Changed Type"

```

### Query errors

> This is an auto-error query that locates errors that would be loaded as blank to the sheets.

```powerquery
Let
Source = #"Check Data Structure",
    #"Renamed Columns1" = Table.RenameColumns(Source,{{"Dead", "Deads"}, {"B.Dead", "B.Deads"}, {"Totals Dead", "Totals Deads"}}),
  #"Detected Type Mismatches" = Let
    tableWithOnlyPrimitiveTypes = Table.SelectColumns(#"Renamed Columns1", Table.ColumnsOfType(#"Renamed Columns1", {type nullable number, type nullable text, type nullable logical, type nullable Date, type nullable datetime, type nullable datetimezone, type nullable Time, type nullable duration})),
    recordTypeFields = Type.RecordFields(Type.TableRow(Value.Type(tableWithOnlyPrimitiveTypes))),
    fieldNames = Record.FieldNames(recordTypeFields),
    fieldTypes = List.Transform(Record.ToList(recordTypeFields), Each [Type]),
    pairs = List.Transform(List.Positions(fieldNames), (i) => {fieldNames{i}, (v) => If v = Null Or Value.Is(v, fieldTypes{i}) Then v Else Error [Message = "The type of the value does not match the type of the column.", Detail = v], fieldTypes{i}})
in
    Table.TransformColumns(#"Renamed Columns1", pairs),
  #"Added Index" = Table.AddIndexColumn(#"Detected Type Mismatches", "Row Number" ,1),
  #"Kept Errors" = Table.SelectRowsWithErrors(#"Added Index", {"File Block", "After(A) - Before(B)", "Governor Name", "Governor ID", "Power", "Alliance", "Kill Points", "Deads", "Tier 4 Kills", "Tier 5 Kills", "Rss Assistance", "Alliance Help", "Notes", "B.Kill Points", "B.Deads", "B.Tier 4 Kills", "B.Tier 5 Kills", "B.Rss Assistance", "B.Alliance Help", "B.Notes", "Totals Kill Points", "Totals Deads", "Totals Tier 4 Kills", "Totals Tier 5 Kills", "Totals Rss Assistance"}),
  #"Reordered Columns" = Table.ReorderColumns(#"Kept Errors", {"Row Number", "File Block", "After(A) - Before(B)", "Governor Name", "Governor ID", "Power", "Alliance", "Kill Points", "Deads", "Tier 4 Kills", "Tier 5 Kills", "Rss Assistance", "Alliance Help", "Notes", "B.Kill Points", "B.Deads", "B.Tier 4 Kills", "B.Tier 5 Kills", "B.Rss Assistance", "B.Alliance Help", "B.Notes", "Totals Kill Points", "Totals Deads", "Totals Tier 4 Kills", "Totals Tier 5 Kills", "Totals Rss Assistance"}),
    #"Renamed Columns" = Table.RenameColumns(#"Reordered Columns",{{"Deads", "Dead"}, {"B.Deads", "B.Dead"}, {"Totals Deads", "Totals Dead"}})
in
  #"Renamed Columns"

```

### Green sheets as queries

> These queries load the tables from the green columns (check update notes).

#### Hall of heros table (HOH)

```powerquery
Let
    Source = Excel.Workbook(File.Contents(p_PathToMI & "\" & p_FinalPathToMI), Null, True),
    tbHallOfHeroes_Table = Source{[Item="tbHallOfHeroes",Kind="Table"]}[Data],
    #"Filtered Rows" = Table.SelectRows(tbHallOfHeroes_Table, Each ([ID] <> "Fill either Manual ID or Manual Name")),
    #"Changed Type" = Table.TransformColumnTypes(#"Filtered Rows",{{"Name", type text}, {"ID", Int64.Type}, {"Manual ID", Int64.Type}, {"Manual Name", type text}, {"Inf_T5 Kills", Int64.Type}, {"Cav_T5 Kills", Int64.Type}, {"Arch_T5 Kills", Int64.Type}, {"Siege_T5 Kills", Int64.Type}, {"Inf_T4 Kills", Int64.Type}, {"Cav_T4 Kills", Int64.Type}, {"Arch_T4 Kills", Int64.Type}, {"Siege_T4 Kills", Int64.Type}, {"Inf_T3 Kills", Int64.Type}, {"Cav_T3 Kills", Int64.Type}, {"Arch_T3 Kills", Int64.Type}, {"Siege_T3 Kills", Int64.Type}, {"Inf_T2 Kills", Int64.Type}, {"Cav_T2 Kills", Int64.Type}, {"Arch_T2 Kills", Int64.Type}, {"Siege_T2 Kills", Int64.Type}, {"Inf_T1 Kills", Int64.Type}, {"Cav_T1 Kills", Int64.Type}, {"Arch_T1 Kills", Int64.Type}, {"Siege_T1 Kills", Int64.Type}, {"Total T5", Int64.Type}, {"Total T4", Int64.Type}, {"Total T3", Int64.Type}, {"Total T2", Int64.Type}, {"Total T1", Int64.Type}, {"Sieges", Int64.Type}, {"Total Of totals", Int64.Type}, {"GL deaths", type text}})
in
    #"Changed Type"
```

#### Payment CP table

```powerquery
Let
    Source = Excel.Workbook(File.Contents(p_PathToMI & "\" & p_FinalPathToMI), Null, True),
    tbOldCP13_Table = Source{[Item="tbPaymentCP",Kind="Table"]}[Data],
    #"Filtered Rows" = Table.SelectRows(tbOldCP13_Table, Each ([ID] <> "Fill either Manual ID or Manual Name")),
    #"Changed Type" = Table.TransformColumnTypes(#"Filtered Rows",{{"Name", type text}, {"ID", Int64.Type}, {"Manual ID", Int64.Type}, {"Manual Name", type text}, {"Payment Value (M)", Int64.Type}, {"Who agreed", type text}, {"Job descrition", type text}})
in
    #"Changed Type"

```

#### Pre-KVK Status table

```powerquery
Let
    Source = Excel.Workbook(File.Contents(p_PathToMI & "\" & p_FinalPathToMI), Null, True),
    tbPreKVKstat_Table = Source{[Item="tbPreKVKstat",Kind="Table"]}[Data],
    #"Filtered Rows" = Table.SelectRows(tbPreKVKstat_Table, Each ([ID] <> "Fill either Manual ID or Manual Name")),
    #"Changed Type" = Table.TransformColumnTypes(#"Filtered Rows",{{"Name", type text}, {"ID", Int64.Type}, {"Manual ID", Int64.Type}, {"Manual Name", type text}, {"Pre KVK Stat", Int64.Type}})
in
    #"Changed Type"

```

#### Zeroed IDs table

```powerquery
Let
    Source = Excel.Workbook(File.Contents(p_PathToMI & "\" & p_FinalPathToMI), Null, True),
    tbZeroedIDs_Table = Source{[Item="tbZeroedIDs",Kind="Table"]}[Data],
    #"Filtered Rows" = Table.SelectRows(tbZeroedIDs_Table, Each ([ID] <> "Fill either Manual ID or Manual Name")),
    #"Changed Type" = Table.TransformColumnTypes(#"Filtered Rows",{{"Name", type text}, {"ID", Int64.Type}, {"Manual ID", Int64.Type}, {"Manual Name", type text}, {"Before Zeroed Deads", Int64.Type}, {"After Zeroed Deads", Int64.Type}, {"Totals", Int64.Type}, {"Manual totals", Int64.Type}})
in
    #"Changed Type"

```

#### Old CP table

```powerquery
Let
    Source = Excel.Workbook(File.Contents(p_PathToMI & "\" & p_FinalPathToMI), Null, True),
    tbOldCP_Table = Source{[Item="tbOldCP",Kind="Table"]}[Data],
    #"Filtered Rows" = Table.SelectRows(tbOldCP_Table, Each ([ID] <> "Fill either Manual ID or Manual Name")),
    #"Changed Type" = Table.TransformColumnTypes(#"Filtered Rows",{{"Name", type text}, {"ID", Int64.Type}, {"Manual ID", Int64.Type}, {"Manual Name", type text}, {"Old CP value", Int64.Type}})
in
    #"Changed Type"

```

## Sample files

### Transformation sample file for Source treated

> This function along with some other supportive (not here as they auto) read the source file and convert them to something readable for 'Source treated'.

**Used by:**

- Source treated.

```powerquery
Let
    Source = Excel.Workbook(Parameter1, Null, True),
    #"Removed Other Columns" = Table.SelectColumns(Source,{"Data"}),
    #"Expanded Data" = Table.ExpandTableColumn(#"Removed Other Columns", "Data", {"Column1", "Column2", "Column3", "Column4", "Column5", "Column6", "Column7", "Column8", "Column9", "Column10", "Column11"}, {"Column1", "Column2", "Column3", "Column4", "Column5", "Column6", "Column7", "Column8", "Column9", "Column10", "Column11"}),
    #"Promoted Headers" = Table.PromoteHeaders(#"Expanded Data", [PromoteAllScalars=True]),
    #"Changed Type" = Table.TransformColumnTypes(#"Promoted Headers",{{"Governor Name", type text}, {"Governor ID", Int64.Type}, {"Power", type any}, {"Alliance", type any}, {"Kill Points", Int64.Type}, {"Deads", Int64.Type}, {"Tier 4 Kills", Int64.Type}, {"Tier 5 Kills", Int64.Type}, {"Rss Assistance", type any}, {"Alliance Help", type any}})

In
    #"Changed Type"

```

#### UPDAT NOTES

1. The query simple sample block was changed to accept all sheetsnames, so all names are now able to be accepted, but then, anysource file <span style="color:red">**can't ever have more than one sheet.**</span>

# About the sheets for Report

## Sheet: settings

COLOR:  **Red** 

In this sheet you can:

- Personalize most calculations on the file like player bins and goals, value of T4 and T5 kills and deaths, GL data into calculation rate, source file path and status bins.

### TO UPDATE

- [ ] Change the layout.

- [ ] Fix the number of players in each bin equation.

- [ ] Clean up unnecessary information of fix it.

## Sheet: Kills and Goals distributions

COLOR: White

In these sheets you can visualize the date easily and change the goals if that is interesting.

### ABOUT GRAPHICS

#### Achieved or not requirements.

> This shows easily where most people haven't or have achieved the goals with the left graphic.
> 
> On the second graphic (on the right) it shows easily the proportions of each bin and the amounts there.

<img title="1.9" src="https://github.com/GabrielOlC/GeFu_BackUP/blob/main/.Images/Picture1.jpg?raw=true" alt="7.7" data-align="center">

#### T4 / T5 kills (imported)

> Works the same as 'achieved or not requirements' but this for kills, the only difference is that the tax of players in that rank is also shown as percentage here, so one can relate the amount of kills in that bin and the amount of kills.

<img title="1.8" src="https://github.com/GabrielOlC/GeFu_BackUP/blob/main/.Images/Picture2.jpg?raw=true" alt="7.7" data-align="center">

## Sheet: Hall of heros, PRE KVK-STAT, Old CP and Payment, Zering Register

COLOR: <span style="color:green">**Green**</span>

These sheets are responsible for bringing up the values that aren't in the data source files, mostly because it is prints or chat data.

To fill up these, one needs to fill either the 'Manual ID' or 'Manual Name', the equations will fill up automatically the name and ID and then fill up the data columns. And if the ID is duplicated, the ID will be colored red.

**Note about HALL OF HERROS**

On this table, I made an update, and now it is possible to analyze right away if the values one filled up are logical...

The column called "GL dead" bring up the "Dead in kvk" from summed data, and if it is smaller than the total dead, shows up a message asking to verify the values filled again. It is possible that this message shows up because the last scan was made too soon (there were several fights after the scan)

## Sheet: Check Data Structure, Imported Data, check Data Structure Erros

COLOR: **Blue**

> These sheets are the result of the queries, so it is **important to say that any data change in the excel here, WILL NOT be saved, as they all come from the source file.** So, if you'd like to change some value there, it is necessary to change it in the source files, so the same data will be change to all queries that use that  data.

### What are they for

#### Check data structure.

> This is the most important sheet as it shows the step-by-step calculations per group of ID's. There you can analyze every calculation result for each player, and this way, identify any possible source errors (there are many support columns and filters that show the most common ones, but the scan is always crazy, so... there always some new error).

**Most common errors found till today:**

- [x] Many more were found later on, they are all explain on the file itself, check the others there (so far on now, it is 9)

- **Negative values.**
  
  - This happens when the 'after' value is 'smaller' than the before value for the block.

- **Player not in summed data.**
  
  - This happens when the scan catches up someone who was not considered in the top 300 in the start of KVK (possible someone who was off map and pop up during kvk). This can be ignored if those aren't imported people.

- **Main and secondary columns are not supposed to be empty.**
  
  - This happens when some data from source file is empty.

- **Blocks aren't logical.**
  
  - This happens when block Fn +1 is bigger than Fn, this is like "negative values".

#### Check data structure ERRORS.

> This table works like 'check data structure' but for the query -- It finds errors on the queries and calculations. The most common error to find here is text on numbers, comma ( , ) instead of point ( . ) on the numbers, etc.

#### Imported data.

This sheet is the next stage of 'check data structure' where all ID are merged into one, so this table shows the total of total values. This is mostly an internal sheet for graphics.

## Sheet: Summed Data

COLOR: Black

This sheet gets the data coming from the blue and green sheets to do all the calculations.

### About the Pink columns

These are manual columns with important data and must be filled properly!

#### TOP POWER

This is the player rank goal, after filling in all other data, sort it by power and use the formula =Row()-n to calculate the ranks and then copy and paste this column as text to be able to sort the table again later for other columns

#### Main acc ID

Put the players farms and outs ID here, so it is easier to track up people and make calculations putting together players and not accounts contribution. When it is empty the cells will be yellow.

#### System and player status

This column is for sorting data, in the settings sheet, the bins can be changed as wish, just not the ones made as 'YES' for system -- those are being used by some equation and that update shall be done in both the equations and the bins.

It is used by:

- .

#### Name, ID, Pre_PlayerPower, Alliance {#name-id-pre_playerpower-alliance .Title-4 .unnumbered}

These columns shall be copied from the pre kvk scan and pasted here as text. If any ID or power was copied as a blank value, the indicators above will be above 0.

<img title="" src="https://github.com/GabrielOlC/GeFu_BackUP/blob/main/.Images/Picture3.jpg?raw=true" alt="7.7" data-align="center">

### About the Red columns

These columns are simple the data from 'imported data' sort up to this sheet. **Do not change anything here as they all are equations**.

- Red = data considered as in war.

### About the Yellow columns

These columns are the same as Red, but it gets the data considering all the kvk. **Do not change anything here as they all are equations**.

- Yellow = data considered as out war.

### About the Green columns

HOH T4 dead, HOH T5 dead, PRE KVK stats, Old kvk CP, Payment CP and manual CP are manual values. **Do not change anything here as they all are equations**.

- Green = data from manual sheets and CP related

##### UPDATE

> I've changed this to work with an external file with the exact same tables in another separate file.

#### CP from Farms and Alts

This get the Cp from farms and Alts on the file, and give it to the main IF the Sup_KeepCPfromAltFarm is not set as 1

```excel-formula
=SUMPRODUCT(
    ([Main acc ID] = [@ID]) *
    NOT([Sup_KeepCPfromAltFarm]) *
    (
        Settings!$B$11 *
        (
            ([System Status] = "Farm") +
            ([System Status] = "Farm Top 300")
        ) +
        (Settings!$B$12 * ([System Status] = "Alt"))
    ),
    [Sup_CPGain]
)

```

> Logic (Boolean)
> Sum the array with the condition: If both <span style="color:pink">**main ACC**</span> and <span style="color:white">**KeepCPfromAltFarm**</span> are true and [Settings allowing farm transference and (<span style="color:pink">**System Status**</span> is either “Farm” or “Farm Top 300”) are true or (setting allowing Alt transference and <span style="color:pink">**System status** </span> is True)]
>     THEN: <span style="color:white">**CPGain** </span>
>     ELSE: 0 

### About the White columns (always remember to update)

These columns are columns that are supposed to be hidden, and the values here are a in step from another equation (these will be explained at the equation that use this)

#### Sup_HOH T4 + HOH T5 Kills, used by:

- Purple: Kills rank

- Colorless: Kill goals achieved

#### Sub_Align dead CP, used by:

- Colorless: Avaible CP Points

#### Sup_Zeroed T4 deads, used by:

- Colorless: Avaible CP Points

- Colorless: Sp_Dead goals achieved

- Colorless: GL\_ Dead Goals Achieved

#### Sup_Zeroed T5 deads, used by:

- Colorless: Avaible CP Points

- Colorless: Sp_Dead goals achieved

- Colorless: GL\_ Dead Goals Achieved

#### Sup_Goals Achieved , used by:

- Goals Contribution

- Player Standards

#### Sup_UseStatus, used by:

- Colorless: Avaible CP Points

#### Sup_CPGain

- 
  
  #### Sup_KeepCPfromAltFarm

- 

### About the Purple columns

- These columns are just the ranks, they include using the same formulas. RANK.EQ(the value to find rank, the other values, ascending or descending)

### About the Blue columns

These columns are only meant to help with sorting data for analysis, can be changed and deleted as needed.

##### Sup_HOH T4 + HOH T5 Kills

This is a simple equation that sums the kills in the scan (RED). **The name HOH is wrong by the way, but to not change data I kept it :)**

### About the Orange columns

These columns are indicators.

#### Achievements Contributio

This is meant to analyze each player's real contribution values. Meanings:

- -1 meaning one did not have any contribution.

- 0 means the individua has achieved 100% of their goals.

- \> 0 is how much more one did above their goal, **the bigger the
  better.**

- \< 0 means one did not achieve the goal, **the lower the worse they
  did.**

**More how about it works**

The objective of this indicator is to get kills and dead of T4 and T5 and turn it all into a number we can sort to get contributions, people with negative values didn't reach their goals

**UPDATE NOTE**

- I changed this to work like X times the goal to be summed on the final report with a better proportion.

```excel-formula
=IF(
    [@[Sup_UseStatus]],
    (
        SUM(
            [@[Kill goals achieved]] *
            XLOOKUP(
                [@[Player Goals]],
                Settings!$T$4:$T$11,
                Settings!$Y$4:$Y$11
            ),
            IF(
                AND(
                    [@[HOH T4 Deads]] = 0,
                    [@[HOH T5 Deads]] = 0
                ),
                Settings!$J$9 *
                [@[GL_ Dead Goals Achieved]] *
                XLOOKUP(
                    [@[Player Goals]],
                    Settings!$T$4:$T$11,
                    Settings!$Z$4:$Z$11
                ),
                [@[SP_Dead goals achieved]] *
                XLOOKUP(
                    [@[Player Goals]],
                    Settings!$T$4:$T$11,
                    Settings!$Z$4:$Z$11
                )
            )
        ) /
        XLOOKUP(
            [@[Player Goals]],
            Settings
```

> **TRANSLATION**
> 
> If the <span style="color:white">**status**</span> is true
> 
>         THEN do a sum (Kill + dead TAX) ELSE says“status disabled”.
> 
>             Sum 1. Kill % * Kill tax proportion¹
> 
>             Sum 2. If both T4 and T5 HOH dead is 0 (noHOH then)
> 
>                 THEN GL setting control * dead % * Dead taxproportion²
> 
>                    ELSE dead % * Dead tax proportion²
> 
>         Dividing all the sum for the total of thegoal to convert the value from factor % to a % of range 1 (this means thatinstead, the values come calculated as the goal—that is not from 0 to 1, itcomes calculating in the base of 1 = 100%
> 
>        And the doing less 1 (I think this way’sbetter to understand when seeing a lot of this values, you don’t have to think200% is double, you think 200% is 200% more than the goal. And when lookingdown you see that -100% is all the goal out and not 0 as all the goal out)
> 
> 
> 
> 1 – KILL TAX PROPORTION (<span style="color:red">**on settings [red]**</span>): This calculates howmuch kills worth both in the goals and the bases. The expression / logic is:
> 
>         =<span style="color:lightblue">(SUM(J4:J5)/SUM(J4:J7))</span>/<span style="color:lightgreen">(R4/SUM(R4,S4))</span>
> 
>         BLUE: Thesum of the kill bases (T4 and T5) / all troops base (T4 and T5 kills and dead).And all this / GREEN: The kill goal / the total goal**. In another words** it is the Tax of Kill valor / tax of kills goals, the result is how much % iskills considering the kills valor in the base of goals.
> 
> 2 – DEAD TAX PROPORTION <span style="color:red">(**on settings [red]**</span>): This calculates howmuch dead worth both in the goals and the bases. The expression / logic is:
> 
>         =<span style="color:lightblue">SUM(J6:J7)/SUM(J4:J7)</span>/<span style="color:lightgreen">(S4/SUM(R4,S4))</span>
> 
>         BLUE: Thesum of the dead bases (T4 and T5) / all troops base (T4 and T5 kills and dead).And all this / GREEN: The dead goal / the total goal. **In another words** it is the Tax of dead valor / tax of dead goals, the result is how much % is deadconsidering the kills valor in the base of goals.

**The equations above are based on the following formula**

This tells the weight of Kills and Dead on the base (this is the caps for every 100% the player do to each goal, let's say TaxK is 30% and player do 200% of that goal, one gets a final score of 2\*30% for kills, )

$$
Taxk = \frac{T4k + T5k}{T4k + T5k + T4d + T5d}\ (Tax\ of\ kills)
$$

$$
Taxd = \frac{T4d + T5d}{T4k + T5k + T4d + T5d}\ (tax\ of\ dead)
$$

This tells the weight of Kills and Dead inside the goals (in the system, it calculates for each rank)

$$
TaxGk = \frac{Gk}{Gk + Gd}\ (tax\ of\ goals\ for\ kills)
$$

$$
TaxGd = \frac{Gd}{Gk + Gd}\ (tax\ of\ goals\ for\ dead)
$$

This convey the t4/t5 kills and dead made by the player into a proportion equivalent to the goals (the goals are the proportion of kills one needs to do based on its own contribution / power)

$$
TaxRk = \frac{T4k + T5k}{power}\ (tax\ of\ real\ values\ for\ kils)
$$

$$
TaxRd = \frac{T4d - T4zd + T5d - T5zd}{power}\ (tax\ of\ real\ values\ for\ dead
$$

$$
TaxRdgl = \frac{Dead - T4zd - T5zd}{power}\ (tax\ of\ real\ values\ for\ deads\ gl)
$$



**(tax of contributions for kills / dead)**

This is where the balancing happens. The objective of the equation is to join into 1 singular value the contributions of kills and dead considering power, rank goals and bases. To achieve that, we up or downscaling the real points (TaxR) made by the player to value inside the goals scale.

$$
TaxCk = TaxRk*\left( \frac{Taxk}{TaxGk} \right) \rightarrow \ \frac{T4k + T5k}{power}*\left( \frac{\frac{T4k + T5k}{T4k + T5k + T4d + T5d}}{\frac{Gk}{Gk + Gd}} \right)
$$

**(KPI - Contribution)**

> This is the final step to make the proportionuseful for ranking. We are getting the Up/down scaled points made by the player/ the goals themselves. If the player did exactly the points needed, theequation will return 1. The player may achieve the goals by doing 100% of killsgoals points or 100% of dead goals points, or any other combination based onTaxK or D. With this equation, if the player does 80% kills points and 120%dead points, they won’t essentially turn back a 1 result. It is easier to thinkthat the Tax proportion are equal to 100% of the goal, so every time a player does100% of their kill goals, they get TaxK %, same for TaxD.  So, let’s say TaxK = 30%, and TaxD = 70%, andthe player did 200% of their kill goals, they would achieve 60% of the generalgoal (KPI) 2*30%. That is, there would be missing only 40% more to achieve thegeneral goa. That is, the player would have to achieve 57% (40%/TaxD) of theirdead goal to get a 40% general goal and get a KPI 100%. Which we then do -1 toget a KPI of 0% (did nothing more or less then should). Noticed if the playerhad done 100% of dead goals too, they’d get a KPI of 130% or 30% (did 30% morethan had to, which is equivalent to do 200% of kill goals) while if someone haddone the inverse 100% kills and 200% dead, one would have a KPI of 70%

$$
Cont = \frac{(TaxC_k + TaxC_d \parallel TaxRd_{gl})}{(G_k + G_d)} - 1 
\rightarrow 
\frac{\left(TaxR_k \cdot \frac{Tax_k}{TaxG_k} + TaxRd \parallel TaxRd_{gl} \cdot \frac{Tax_d}{TaxG_d}\right)}{(G_k + G_d)} - 1 \rightarrow
$$

$$
\frac{
    \left(
        \frac{T4_k + T5_k}{power} \cdot 
        \left(
            \frac{\frac{T4_k + T5_k}{T4_k + T5_k + T4_d + T5_d}}
            {\frac{G_k}{G_k + G_d}}
        \right)
    \right) 
    + 
    \left(
        \frac{T4_d - T4_{zd} + T5_k - T5_{zd}}{power} \cdot 
        \left(
            \frac{\frac{T4_d + T5_d}{T4_k + T5_k + T4_d + T5_d}}
            {\frac{G_d}{G_k + G_d}}
        \right)
    \right)
}{G_k + G_d} - 1
$$

* T4k and T5k are the bases of T4 and T5 kills

* T4d and T5d are the bases of T4 and T5 dead

* T4zd and T5zd are the zeroed values of TR and T5

* Taxk and Taxd are the proportions of kills (t4+t5) and dead (t4+t5) for
  the bases

* TaxCk and TaxCd are the proportions of the bases for kills and dead
  related to the goals

* Gk and Gd are the goals values set for the KVK (for each rank as a tax
  kill or dead amount / power)

* TaxRk, TaxRd and TaxRdgl are the proportions of kills and dead the
  player made

* TaxGk and TaxGd are the proportions of goals

\<\>\<\>\<\> NOTE you, myself \<\>\<\>\<\> 

note that the equation is looks truly unfair while we are killing or getting dead of T4 or T5 as it doesn't count them separately but remember that the goals are For Kills or Dead (T4 + T5) while the bases takes values for T4 and T5 and summed to be used as KILL or DEAD. I bet that you're reading and thinking of upgrading this to get the goals as T4 and T5, but DO remember! The players get CP on those bases, so they are kinda getting pay already for it, getting the \$ to buy rank spots in events. Moreover, the goals are complete adjustable for each ranks mirroring their reality, and the ranks are easily adding up (sort of). So, updating the equation to give more to T5 and less to T4 would make the T4 players have to do way more while the T5 players way less, if both players have the same raw contribution bases, they will have a better fair telling of weather they have giving or not their best on war. AKA, KEEP!, IT!, AS!, IT!, IS! ,-, Ps. Simulator is at KVK 13 file on setting page.

#### Goals Contribution

This is meant to tell you about how the player contributions are reacting across all players. You can think of this numbers as in a chart, as they are normalized, is easier to see the gaps between them, and the bigger they are, it tells you that just few players had achieved those standards. 

One very interesting thing you can also see here is, if the player goals is negative, it means that player did not reach the base you picked on Goals Table on Settings \[red\]. Example, if a green bin player has a negative value, it doesn't mean they did not reach the bin goals, it means they did not reach the base you picked, if you picked the last base \[8\] means if one was at rank \[8\] one wouldn't reach the goal.

```excel-formula
=IF(
    [@[Sup_UseStatus]],
    (
        (
            [@[Sup_Goals Achieved]] - 
            XLOOKUP("Y", Settings!$W$4:$W$11, Settings!$AA$4:$AA$11)
        ) / 
        (
            MAX([Sup_Goals Achieved]) - 
            XLOOKUP("Y", Settings!$W$4:$W$11, Settings!$AA$4:$AA$11)
        )
    ),
    0
)
```

> **The equation for normalization:**

$$
\text{Normalized Value} = \frac{\text{Value} - \text{Mean}}{\text{Max Value} - \text{Min Value}}
$$

> It was adapted: The mean is the choosed value on the goal table (just need put a Y in the 'pick base')

##### Sup_Goals Achieved

This creates a base to be used on the indicators. It is a variation of the one used on achievements contributions.

```excel-formula
=SUM(
    (
        [@[Kill goals achieved]] *
        XLOOKUP(
            [@[Player Goals]],
            Settings!$T$4:$T$11,
            Settings!$Y$4:$Y$11
        )
    ),
    (
        Settings!$J$8 *
        [@[GL_ Dead Goals achieved]] *
        XLOOKUP(
            [@[Player Goals]],
            Settings!$T$4:$T$11,
            Settings!$Z$4:$Z$11
        )
    ),
    (
        [@[SP_Dead goals achieved]] *
        XLOOKUP(
            [@[Player Goals]],
            Settings!$T$4:$T$11,
            Settings!$Z$4:$Z$11
        )
    )
)
```

> The formula is the same as achievements contributions, but only considering the kill/dead tax proportion on goals

#### Player Standards

This is another indicator that uses a normalization meant to find 'outliers', the expected here is to find the values that are "out" the expected for each player on their rank.

```excel-formula
=([@[Sup_Goals Achieved]]-AVERAGE([Sup_Goals Achieved]))/STDEV.S([Sup_Goals Achieved])
```

> The equation used for normalization:

$$
\text{Normalized Value} = \frac{\text{Value} - \text{Mean}}{\text{STDV.s}}
$$

### About the Colorless columns

These columns are where all the calculations are. **Do not change anything here, as it will potentially affect CP, yellow and red list.**

#### Avaible CP Points

```excel-formula
=IF(Settings!$B$20,0,
  IF(AND([@[Sup_UseStatus]],[@[Main acc ID]]=""),
     SUM([@[Sup_CPGain]]*(1+XLOOKUP([@[Player Status]],Settings!$A$15:$A$18,Settings!$B$15:$B$18,0)),[@[CP from Farms and Alts]]),
     IF([@[Sup_KeepCPfromAltFarm]],
        [@[Sup_CPGain]]*(1+XLOOKUP([@[Player Status]],Settings!$A$15:$A$18,Settings!$B$15:$B$18,0)),0
       )
    )
 )
```

> **Logic**
> 
> IF both <span style="Color:white">**status**</span>is active and the <span style="Color:pink">**foreign key**</span> of main acc id is empty (the account is not a sub account)
>         THEN: Sum the <span style="Color:white">**clean CP**</span> + the bonus for the respective role that are defined on the settings page and the <span style="Color:lightgreen">**CP from farms and alts**</span>
>         ELSE: If player wanted to <span style="Color:white">**keep CP of their farm/alts on their farm/alts**</span>
>                 THEN: Sum the <span style="Color:white">**clean CP**</span> + the bonus for the respective role that are defined on the settings page
>                 ELSE: 0
> 
> **Notice that** the farms and alts cp do not get any extra CP (verified)

##### Sup_CPGai

```excel-formula
=[@[Imported TL_T4 Kills]]*Settings!$B$4+[@[Imported TL_T5Kills]]*Settings!$B$5+[@[HOH T4 dead]]*Settings!$B$6+[@[HOH T5 dead]]*Settings!$B$7
+[@[PRE KVK stats]]
+[@[Payment CP]]
+IF(Settings!$B$9,[@[Old kvk CP]],0)
-[@[Sub_Align dead CP]]
-([@[Sup_Zeroed T4 dead ]]*Settings!$B$6+[@[Sup_Zeroed T5 dead]]*Settings!$B$7)
+[@[Manual CP]]
```

> **The logic of this equation is**
> 
> - Get the <span style="color:red">T4 and T5 kills</span> and multiply it by its weight (balance) saved on the setting list and do the same for the <span style="color:red">deaths</span>.
> - Sum the <span style="color:lightgreen">pre kvk stat</span>.
> - Sum the <span style="color:lightgreen">payment Cp</span>.
> - Sum <span style="color:lightgreen">old kvk CP</span> for IF it is set as TRUE in the system.
> - Subtract the <span style="color:lightgreen">alignment</span> (more below).
> - Subtract zeroing troops balanced (more below).
> - Sum <span style="color:lightgreen">manual Cp</span> (green).



##### Sup_KeepCPfromAltFarm

> This is manual column, where someone doesn't want to send the CP from
> farms and Alts used on war (that received points for cp) to the main.

- If one doesn't want to transfer the CP points, then just put the
  
  > number 1 on the respective alts and farms from that main (or don't
  > put any ID on the farm/alt acc, but this will cut tracking)

##### Sup_UseStatus {#sup_usestatus .Title-5 .unnumbered}

> This simple equation tells the system whether the current ID is or not
> a valid ID according to the criteria defined (this column may change a
> lot from kvk to kvk)

```excel-formula
=IF(
    AND(
        OR(
            [@[System Status]] = "Active",
            [@[System Status]] = "Alt",
            [@[System Status]] = "Farm Top 300"
        ),
        [@[Player Status]] <> "Data Error"
    ), 1, 0
)
```

##### Sub_Align dead CP

This function is meant to remove the extra dead points one achieved by fighting out of war...

- IF one day we are to give out of war points, it is here we will make the change.

```excel-formula
=MAX(
    0,
    IF(
        XLOOKUP(
            [@ID],
            tbHallOfHeroes[ID],
            tbHallOfHeroes[Total Of totals],
            0
        ) > [@[Imported TL_Deads]],
        IF(
            SUM(
                [@[HOH T4 Deads]],
                [@[HOH T5 Deads]]
            ) - [@[Imported TL_Deads]] > [@[HOH T4 Deads]],
            (
                [@[HOH T4 Deads]] * Settings!$J$7 +
                (
                    SUM(
                        [@[HOH T4 Deads]],
                        [@[HOH T5 Deads]]
                    ) - [@[Imported TL_Deads]] - [@[HOH T4 Deads]]
                ) * Settings!$J$8
            ),
            (
                SUM(
                    [@[HOH T4 Deads]],
                    [@[HOH T5 Deads]]
                ) - [@[Imported TL_Deads]]
            ) * Settings!$J$7
        ),
        0
    )
)

```

> **Translation**
> 
> For only valuesabove 0,  
> If the <span style="color:lightgreen">**HOH dead**</span> is > <span style="color:red">**than in war dead**</span> (TL_deads)
> 
>         THEN calculatethe number of troops **<u>to count out</u>**, ELSE, 0 (cause if HOH dead is< then TL, 100% of TL is meant to counted.)
> 
>         If the total of <span style="color:lightgreen">**dead at HOH**</span> – the <span style="color:lightgreen">**TL dead**</span> (**<u>the amount out</u>**,difference) is > of HOH T4dead, then there are both T4 and T5 HOH troops.
> 
>                 THEN get all T4balanced for T4 + the difference amount left balanced for T5. Else it is allT4, ELSE get the difference (total amount that is T4) balanced for T4.

**OBSERVATIONS**

- Names:
  
  - TOTAL HOH: all troops registered on HOH
  
  - TL: Imported data from scan during war
  
  - T4/T5: Only the totals of T4 and T5 dead on HOH

- When **HOH equals TL AND** \| Means the player only fought during the war
  
  - T4/T5 equals TL: All kills are of T4 and T5
    
    - Result: No changes.
  
  - T4/T5 is less than TL: Not all kills are T4 and T5
    
    - Result: No changes.
    
    - T4/T5 is greater than TL: This situation should never occur; TL can't be bigger then HOH

- When HOH is greater than TL \| Means player fought out the war or after the last scan or shared earlier HOH
  
  - T4/T5 equals TL: All kills of T4 and T5 were during war (or guy is very lucky and killed them after war and at same value as the scan)
    
    - Result: No changes.
  
  - T4/T5 is greater than TL: Some Kills of T4 and T5 happened out the war or after last scan
    
    - Result: Compensation is applied by reducing CP.
  
  - T4/T5 is less than TL: Not all kills are T4 and T5 (player killed many of other type, including out war or after last scan. Probably got zeroed or trade)
    
    - Result: No changes
    
    - Note: No changes mean No alignment is applied (0), which means T4/T5 (that are lower than TL) will be the only values that are considered, and not the sieges or any other troop type

- When HOH is less than TL
  
  - T4/T5 is less than TL: Not all kills are T4 and T5
    
    - Result: No changes.
  
  - T4/T5 equals TL: Note: This scenario is impossible; TL can't be bigger than HOH
  
  - T4/T5 is greater than TL: Note: This scenario is impossible; TL can't be bigger than HOH

##### Sup_Zeroed T4 deads and Sup_Zeroed T5 deads (zeroing troops)

```excel-formula
/* FOR T4
plaintext
=IFERROR(
    SUMIF(
        tbZeroedIDs[ID],
        [@ID],
        tbZeroedIDs[Totals]
    ) * 
    (
        [@[HOH T4 Deads]] / 
        SUM(
            [@[HOH T4 Deads]],
            [@[HOH T5 Deads]]
        )
    ),
    0
)

/* FOR T5
plaintext
=IFERROR(
    SUMIF(
        tbZeroedIDs[ID],
        [@ID],
        tbZeroedIDs[Totals]
    ) * 
    (
        [@[HOH T5 Deads]] / 
        SUM(
            [@[HOH T4 Deads]],
            [@[HOH T5 Deads]]
        )
    ),
    SUMIF(
        tbZeroedIDs[ID],
        [@ID],
        tbZeroedIDs[Totals]
    )
)
```

>  The objective of this function is to get the dead that aren't set as t4 and t5 and balance it as T4 and T5 based on the tax of the <span style="Color:lightgreen">**HOH dead**</span>, if that gives an error (if not T4 or T5 dead are filled) that will consider the zeroing dead as T5.

#### Kill goals achieved

This column says if the ID has or not achieved the setting goals, case not, it will be colored red.

```excel-formula
=([@[Imported TL_T4 Kills]]+[@[Imported TL_T5Kills]])/[@[Pre_Player Power]]
```

> The logic is simple, the <span style="Color:red">**total kills**</span> / the <span style="Color:pink">**[power]**</span> gives the power % on kills that is the same base as the [goals]

#### SP_Dead goals achieved

This works like kills, but as zeroing dead doesn't count, this equation also removes the amount of zero dead.

```excel-formula
=IFERROR(
    (
        (
            [@[HOH T4 Deads]] - [@[Sup_Zeroed T4 deads ]]
        ) + 
        (
            [@[HOH T5 Deads]] - [@[Sup_Zeroed T5 deads]]
        )
    ) / 
    [@[Pre_Player Power]],
    0
)

```

>  The logic is 
>  IF error THEN 0 ELSE (<span style="Color:lightgreen">**HOHT4**</span> – <span style="Color:white">**zeroedT4**</span> + <span style="Color:lightgreen">**HOH T5**</span> – <span style="Color:white">**Zeroed T5)**</span> / <span style="Color:pink">**Power**</span> the result is the% of dead on power that is the same base of the <span style="Color:red">**goals**</span>.

#### GL\_ Dead Goals Achieved

This works as the 'SP_DEAD GOALS ACHIEVED' but instead of using the HOH data, uses the GL dead data.

**[UPDATE NOTE:] This no longer uses GL, but in war \[red\] datainstead of HOH (NAME WILL BE KEPT SAME)**

```excel-formula
=IFERROR(
    (
        [@[Imported TL_dead]] - 
        [@[Sup_Zeroed T4 deads ]] - 
        [@[Sup_Zeroed T5 deads]]
    ) / 
    [@[Pre_Player Power]],
    0
)
```

> **The logic is**
> 
> The logic is IF error THEN 0 ELSE (<span style="Color:brown">**GL dead**</span> – <span style="Color:whiote">**zeroed T4**</span> – <span style="Color:white">**Zeroed T5)**</span> / <span style="Color:pink">**Power**</span> the result is the % of dead on power that is the same base of the <span style="Color:red">**goals**</span>

#### Player Goals

This equation finds out what bin the player is. And in case they are set as Rally Garrison Leaders, the calculations will consider that their rank is X rank below what they are (X is what it is set as on the settings). Example, if they rank is the highest (1) and the system is set as a drop of 1, then it will count as rank 2. The maximum will always be the last possible rank (currently 8).

```excel-formula
=XLOOKUP(
    IF(
        [@[Player Status]] = "Rally/Garrison Leaders",
        XLOOKUP(
            [@[Pre_Player Power]],
            Settings!$F$4:$F$11,
            Settings!$N$4:$N$11,
            ,
            1,
            1
        ) + Settings!$B$10,
        XLOOKUP(
            [@[Pre_Player Power]],
            Settings!$F$4:$F$11,
            Settings!$N$4:$N$11,
            ,
            1,
            1
        )
    ),
    Settings!$N$4:$N$11,
    Settings!$M$4:$M$11,
    ,
    -1,
    1
)
```

#### VF_Data Proof Dead

This is an old column to check the data structure, it tells if the data is making sense, but the outcomes depend on the scan being ran in the very last day of KVK. I would exclude it, but you can check here if someone lost troop after the end of all wars or if they are lying on their HOH.

# About the power BI report structure

To give a better loading experience for the players, we are uploading all the excel into Power BI.
Ps. We’ve stopped updating this documentation, so BI looks way different then here – need to check it all again, but as we’re planning on changing bi to a python web, it is not worthy the time spend… 

## About the source pre-load and LOAD

To keep the security of the reports with the free version of OneDrive I created a whole new file which locally loads all date from the reports into a single report that is shared with a public link. This way no one can make any changes on the originals files or see the code.

**Pre-Load file**

```powerquery
Let
    Source = Folder.Files(p_PathToReports),
    #"Filtered Hidden Files1" = Table.SelectRows(Source, Each [Attributes]?[Hidden]? <> True),
    #"Invoke Custom Function1" = Table.AddColumn(#"Filtered Hidden Files1", "Transform File", Each #"Transform File"([Content])),
    #"Renamed Columns1" = Table.RenameColumns(#"Invoke Custom Function1", {"Name", "Source.Name"}),
    #"Removed Other Columns1" = Table.SelectColumns(#"Renamed Columns1", {"Source.Name", "Transform File"}),
    #"Expanded Table Column1" = Table.ExpandTableColumn(#"Removed Other Columns1", "Transform File", Table.ColumnNames(#"Transform File"(#"Sample File"))),
    #"Changed Type" = Table.TransformColumnTypes(#"Expanded Table Column1",{{"Top   Power", Int64.Type}, {"Main acc ID", Int64.Type}, {"System Status", type text}, {"Player Status", type any}, {"Name", type text}, {"ID", Int64.Type}, {"Pre_Player Power", Int64.Type}, {"Alliance", type any}, {"Imported TL_Kill Points", Int64.Type}, {"Imported TL_dead", Int64.Type}, {"Imported TL_T4 Kills", Int64.Type}, {"Imported TL_T5Kills", Int64.Type}, {"Imported TL_Rss Assis", Int64.Type}, {"GL Imported TL_Kill Points", Int64.Type}, {"GL Imported TL_dead", Int64.Type}, {"GL Imported TL_T4 Kills", Int64.Type}, {"GL Imported TL_T5Kills", Int64.Type}, {"GL Imported TL_Rss Assis", Int64.Type}, {"HOH T4 dead", Int64.Type}, {"HOH T5 dead", Int64.Type}, {"PRE KVK stats", Int64.Type}, {"Old kvk CP", Int64.Type}, {"Payment CP", Int64.Type}, {"Manual CP", Int64.Type}, {"Avaible CP Points", type number}, {"Kill goals achieved", Percentage.Type}, {"SP_Dead goals achieved", Percentage.Type}, {"GL_Dead Goals achieved", Percentage.Type}, {"Achievements Contribution", type any}, {"Goals Contribution", Percentage.Type}, {"Player Standards", Percentage.Type}, {"Player Goals", type text}, {"VF_Data Proof Dead", type text}, {"Contribution rank", Int64.Type}, {"Achievements Contributions Rank", Int64.Type}, {"CP Rank", Int64.Type}, {"Kills rank", Int64.Type}, {"Dead in war rank", Int64.Type}, {"Sorting_Type1", type logical}, {"Sorting_Type2", type logical}, {"Sup_HOH T4 + HOH T5 Kills", Int64.Type}, {"Sub_Align dead CP", Int64.Type}, {"Sup_Zeroed T4 dead", type number}, {"Sup_Zeroed T5 dead", type number}, {"Sup_Goals Achieved", type number}, {"Sup_UseStatus", type logical}, {"Merged Status", type text}})
in
    #"Changed Type"

```

**Load**

```powerquery
Let
    Source = Excel.Workbook(Web.Contents("https://onedrive.live.com/download?resid=D1EEAB6F0B7FAB86%2197925&authkey=!AJ5D8Cy-BV_StOg&app=Excel"), Null, True),
    Excel_report_Table = Source{[Item="Excel_report",Kind="Table"]}[Data],
    #"Changed Type" = Table.TransformColumnTypes(Excel_report_Table,{{"Top   Power", Int64.Type}, {"Main acc ID", Int64.Type}, {"System Status", type text}, {"Player Status", type any}, {"Name", type text}, {"ID", Int64.Type}, {"Pre_Player Power", Int64.Type}, {"Alliance", type any}, {"Imported TL_Kill Points", Int64.Type}, {"Imported TL_dead", Int64.Type}, {"Imported TL_T4 Kills", Int64.Type}, {"Imported TL_T5Kills", Int64.Type}, {"Imported TL_Rss Assis", Int64.Type}, {"GL Imported TL_Kill Points", Int64.Type}, {"GL Imported TL_dead", Int64.Type}, {"GL Imported TL_T4 Kills", Int64.Type}, {"GL Imported TL_T5Kills", Int64.Type}, {"GL Imported TL_Rss Assis", Int64.Type}, {"HOH T4 dead", Int64.Type}, {"HOH T5 dead", Int64.Type}, {"PRE KVK stats", Int64.Type}, {"Old kvk CP", Int64.Type}, {"Payment CP", Int64.Type}, {"Manual CP", Int64.Type}, {"Avaible CP Points", type number}, {"Kill goals achieved", Percentage.Type}, {"SP_Dead goals achieved", Percentage.Type}, {"GL_Dead Goals achieved", Percentage.Type}, {"Achievements Contribution", type any}, {"Goals Contribution", Percentage.Type}, {"Player Standards", Percentage.Type}, {"Player Goals", type text}, {"VF_Data Proof Dead", type text}, {"Contribution rank", Int64.Type}, {"Achievements Contributions Rank", Int64.Type}, {"CP Rank", Int64.Type}, {"Kills rank", Int64.Type}, {"Dead in war rank", Int64.Type}, {"Sorting_Type1", type logical}, {"Sorting_Type2", type logical}, {"Sup_HOH T4 + HOH T5 Kills", Int64.Type}, {"Sub_Align dead CP", Int64.Type}, {"Sup_Zeroed T4 dead", type number}, {"Sup_Zeroed T5 dead", type number}, {"Sup_Goals Achieved", type number}, {"Sup_UseStatus", type logical}, {"Merged Status", type text}})
in
    #"Changed Type"


```

## About CP calculation {#about-cp-calculation .Tittle-2 .unnumbered}

This query gets the loaded source merged it with the CP used and calculates the CP left to use in MGE or other events.

```powerquery
Let
    Source = #"KVK Data",
    #"Filtered Rows" = Table.SelectRows(Source, Each ([Sup_UseStatus] = 1)),

    //Removing negative values of CP (that happens when someone Get zeroed And Do Not share HOH – so all the zeroing Is calculated As T5 either they are Or Not T5)
    ToRemoNegatives = Table.AddColumn(#"Filtered Rows", "SortNegativeOut", Each [Avaible CP Points] < 0),
    RemovingNegatives = Table.SelectRows(ToRemoNegatives, Each ([SortNegativeOut] = False)),

    //Grouping the ID And summing the CP values gained On KVK's
    #"Grouped Rows" = Table.Group(RemovingNegatives, {"ID"}, {{"CP gained on KVK", Each List.Sum([Avaible CP Points]), type nullable number}}),

    //Loading the CP used On events
    #"Merged Queries" = Table.NestedJoin(#"Grouped Rows", {"ID"}, #"ALL CP used", {"ID"}, "ALL CP used", JoinKind.LeftOuter),
    #"Expanded ALL CP used" = Table.ExpandTableColumn(#"Merged Queries", "ALL CP used", {"All CP used"}, {"CP used"}),

    //Calculating the CP Left To use in Next events
    #"Replaced Value" = Table.ReplaceValue(#"Expanded ALL CP used",Null,0,Replacer.ReplaceValue,{"CP used"}), //so that we can subtract the value
    #"Inserted Subtraction" = Table.AddColumn(#"Replaced Value", "Current CP Available", Each [CP gained On KVK] - [CP used], type number),

    //Bringing the latest name
    #"Merged Queries1" = Table.NestedJoin(#"Inserted Subtraction", {"ID"}, UniqueIDs, {"ID"}, "UniqueIDs", JoinKind.LeftOuter),
    #"Expanded UniqueIDs" = Table.ExpandTableColumn(#"Merged Queries1", "UniqueIDs", {"Name"}, {"Name"}),
    #"Reordered Columns" = Table.ReorderColumns(#"Expanded UniqueIDs",{"Name", "ID", "CP gained on KVK", "CP used", "Current CP Available"}),
    #"Changed Type" = Table.TransformColumnTypes(#"Reordered Columns",{{"ID", type text}}) //so we can sort it With the text funtion
in
    #"Changed Type"

```

## Suportive queries

These queries aren’t even loaded to the model… Just fill up the other ones Cumulative points

### All cp Used

This query loads the file where are register the CP used by ID

```powerquery
Let
    Source = Excel.Workbook(Web.Contents("https://onedrive.live.com/Download?resid=D1EEAB6F0B7FAB86%2197922&authkey=!AM_t7lBVySZd_zc&app=Excel"), Null, True),
    #"ALL CP used_Sheet" = Source{[Item="ALL CP used",Kind="Sheet"]}[Data],
    #"Promoted Headers" = Table.PromoteHeaders(#"ALL CP used_Sheet", [PromoteAllScalars=True]),
    #"Changed Type" = Table.TransformColumnTypes(#"Promoted Headers",{{"NAME", type text}, {"ID", Int64.Type}, {"CP USED (M)", type number}, {"DATE", type Date}, {"Source", type text}, {"Notes", type text}}),
    #"Inserted Multiplication" = Table.AddColumn(#"Changed Type", "CP Used", Each [#"CP USED (M)"] * 1000000, type number),
    #"Grouped Rows" = Table.Group(#"Inserted Multiplication", {"ID"}, {{"All CP used", Each List.Sum([CP Used]), type number}})
in
    #"Grouped Rows"

```

### Unique Ids

This query gets the loaded data and sort latest unique Name / ID and tells if the ID exist in the last kvk

```powerquery
Let
    AllIDs = #"KVK Data",
    #"Extracted Text Between Delimiters" = Table.TransformColumns(AllIDs, {{"Source.Name", Each Text.BetweenDelimiters(_, "KVK", "."), type text}}),
    MaxVvalue = List.Max(#"Extracted Text Between Delimiters"[Source.Name]),
    #"Added Conditional Column" = Table.AddColumn(#"Extracted Text Between Delimiters", "LastKVK", Each If [Source.Name] = MaxVvalue Then True Else False, type logical),
    #"Filtered Rows" = Table.SelectRows(#"Added Conditional Column", Each ([LastKVK] = True)),
    #"Removed Other Columns1" = Table.SelectColumns(#"Filtered Rows",{"ID", "LastKVK"}),

    //Saving the last kvk ID's
    LastKVKID = #"Removed Other Columns1",

    #"Removed Duplicates" = Table.Distinct(#"Added Conditional Column", {"ID"}),
    #"Removed Other Columns" = Table.SelectColumns(#"Removed Duplicates",{"Name", "ID"}),
    #"Merged Queries" = Table.NestedJoin(#"Removed Other Columns", {"ID"}, #"Removed Other Columns1", {"ID"}, "LastKVKIDs", JoinKind.LeftOuter),
    #"Expanded LastKVKIDs" = Table.ExpandTableColumn(#"Merged Queries", "LastKVKIDs", {"LastKVK"}, {"LastKVK"}),
    #"Replaced Value" = Table.ReplaceValue(#"Expanded LastKVKIDs",Null,False,Replacer.ReplaceValue,{"LastKVK"})
in
    #"Replaced Value"


```

# Global notes -- read in case of bugs

## Change in names

Here is where updates have been done and affect all the names on this file, even if I change them, the original and changed names will always be saved in case of bugs show up cause of names.

## I've changed "real" for "HOH"

- HOH T4 Dead

- HOH T5 dead

- Sup_HOH T4 + HOH T5 Kills

## I've changed "deads" or "Death" to"dead"

- Imported TL_dead

- GL Imported TL_dead

- Sup_Zeroed T4 dead

- Sup_Zeroed T5 dead

- Sub_Align dead CP

- Dead in war rank

## I've changed "archieve" for achieve"

- Achievements Contribution

## Change in functions

## I've change the model for manual inputs

Now instead of writing the manual inputs inside the excel report, it is done in a separated file. This was done because:

* Improve security – people who shall not see the inner codes won’t have the file in hands; at the same time, they won’t be able to change values that they are not supposed to

* Improve the dynamics of the file – we can now easily update a file for all kvk. As all kvk have they own file, if we update kvk 8 it is not run on other kvks… but if we want it to, all we have to do is change the settings last name of KVK 8 for any other source we want and press update.

**WHAT IT CHANGES?**

The xlookup calls the tables with the same name, but with qr\_ at front.

## Change in the source structure

I’ve changed the sources link retrieving. Now they get the links through parameters instead the excel itself… I kept excel think someone could also update the sources, but that is unlike, so I update it to not have an extra sheet/column no one will ever use..

## Repository for old codes

This only for codes that have been changed dramatically.

### archieved code (old version) -- Player GOALS (Updated)

```excel-formula
=IF(
    [@[Pre_Player Power]] / 10^6 >= Settings!$N$4,
    Settings!$T$4,
    IF(
        AND(
            [@[Pre_Player Power]] / 10^6 >= Settings!$N$5,
            [@[Pre_Player Power]] / 10^6 < Settings!$O$5
        ),
        Settings!$T$5,
        IF(
            AND(
                [@[Pre_Player Power]] / 10^6 >= Settings!$N$6,
                [@[Pre_Player Power]] / 10^6 < Settings!$O$6
            ),
            Settings!$T$6,
            IF(
                AND(
                    [@[Pre_Player Power]] / 10^6 >= Settings!$N$7,
                    [@[Pre_Player Power]] / 10^6 < Settings!$O$7
                ),
                Settings!$T$7,
                IF(
                    AND(
                        [@[Pre_Player Power]] / 10^6 >= Settings!$N$8,
                        [@[Pre_Player Power]] / 10^6 < Settings!$O$8
                    ),
                    Settings!$T$8,
                    IF(
                        AND(
                            [@[Pre_Player Power]] / 10^6 >= Settings!$N$9,
                            [@[Pre_Player Power]] / 10^6 < Settings!$O$9
                        ),
                        Settings!$T$9,
                        IF(
                            AND(
                                [@[Pre_Player Power]] / 10^6 >= Settings!$N$10,
                                [@[Pre_Player Power]] / 10^6 < Settings!$O$10
                            ),
                            Settings!$T$10,
                            Settings!$T$11
                        )
                    )
                )
            )
        )
    )
)

```

### SupA1 Frequency (deleted)

This table is meant to be load to the data model and be used at power pivot to visualize the bins (this is what powers the graphic

```powerquery
Let
    Source = #"qr_tbDash",
    #"Filtered Rows" = Table.SelectRows(Source, Each ([System Status] = "Active")),
    #"Removed Other Columns" = Table.SelectColumns(#"Filtered Rows",{"Imported TL_Deads", "Total Kills In war", "Sup_HOH T4 + HOH T5 Kills", "Player Goals", "Contribution"}),
    #"Rounded Off" = Table.TransformColumns(#"Removed Other Columns",{{"Contribution", Each Number.Round(_, 3), type number}}),
    #"Added Conditional Column" = Table.AddColumn(#"Rounded Off", "Contribution Bins", Each If [Contribution] > 0.8 Then "Excelente" Else If [Contribution] > 0.6 Then "Very Good" Else If [Contribution] > 0.4 Then "Good" Else If [Contribution] > 0.2 Then "Well" Else If [Contribution] > 0.1 Then "Minimum" Else If [Contribution] > 0.099 Then "Need do better" Else "Def Dead Weight")

in
    #"Added Conditional Column"
```

**This is used by:**

- Power pivot

##### UPDATES NOTES

- I think I will delete these and only keep the graphics at the new file
  that will be created to merge 2 or more kvks.

**Last updated at 2023-03**

- 2025-04 (updated .docx to .md)
